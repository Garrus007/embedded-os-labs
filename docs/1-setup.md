# Подготовка Raspberry Pi

Вначале необходимо установить ОС на Raspberry Pi (далее RPI). Существует ряд дистрибутивов Linux для RPI, но наиболее известным и широко применяемым (наверное) является официальный дистрибутив Raspberry Pi OS (ранее известный, как Raspbian).

**Термины**

- хост (host) - компьютер, на котором ведется разработка и компиляция
- устройство/девайс/таргет (device/target) - встраиваемая система, под которую осуществляется разработка и на которой осуществляется разработка.

Основаня работа (разработка, компиляция) для встраиваемых систем обычно происходит на хосте, потому что встраиваемая система обладает более слабым процессором (поэтому компиляция будет существенно дольше), меньшим объемом ОЗУ и флеш памяти (которых зачастую нужно очень много для компиляции), а также не имеет средств разработки (компиляторов, не говоря уже об удобных IDE). Поэтому разработка осуществляется на хосте с использованием кросс-компиляции под целевую архитектуру с использованием специального *тулчейна*, а тестирование - на таргете.

Работать с RPI можно различными способами, например, подключив монитор, мышь и клавиатуру, работать с ней как с обычным ПК. Но это не очень удобно, потому что пришлось бы постоянно переключаться между таргетом и хостом или иметь двойной набор переферии. Кроме того, зачастую встраиваемые системы и не имеют возможности подключить к ним монитор и устройства ввода. Поэтому чаще всего с ними работают удаленно, либо подключаясь по UART (aka com-порт) либо по сети с помощью SSH. В данном случае, SSH - это наиболее удобный способ.

Для того, чтобы начать работать с Rasberri Pi, необходимо установить ОС, а также настроить ее, чтобы можно было подключиться с помощью SSH, при этом мы не хотим использовать монитор даже для первоначальной настройки!

> На этом шаге мы установим образ Raspberry Pi OS на RPI и подготовим ее для дальнейшей работы

## 1. Необходимые материалы

- Rasberry Pi 3 (ваш кэп)
- Блок питания для RPI 3. Подойдет блок питания от телефона с Micro USB
- Компьютер с ОС Ubuntu или Arch Linux/Manjaro. Данные инструкции приводятся для Ubuntu и Arch Linux. Если ваш дистрибутив использует другой пакетный менеджер, адаптируйте под него. Наверное, можно использовать виртуальную машину или WSL2. Не проверял.
- Флеш-карта Micro SD. На нее устанавливается образ ОС
- Карт-ридер для работы с Micro SD
- Сеть
  - Варианта А: Wi-Fi роутер (предпочитетельно)
  - Вариант B: сетевой кабель (патч-корд)

## 1. Установка Rasberry Pi OS на флеш-карту

1. Установите программу `Raspberry Pi Imager` для скачивания и прошивки образа

    Ubuntu
    ```
    wget https://downloads.raspberrypi.org/imager/imager_latest_amd64.deb
    sudo dpkg -i imager_latest_amd64.deb
    ```
    Arch Linux/Manjaro
    ```
    sudo pacman -S rpi-imager
    ```
1. Подключите MicroSD картук компьютеру
1. Запустите `Rasberry Pi Imager`.
1. Нажмите `Choose OS` -> `Rasberry Pi OS (other)` -> `Rasberry Pi OS Lite`
1. Нажмите `Choose Storage` и выберите вашу MicroSD карту
1. Нажмите `Write`

## 2. Настройка

После прошивки образа на MicroSD карту, она должна отображаться в системе как два устройства под названиями `boot `и  `rootfs`.

1. Включение SSH сервера

    Cоздайте пустой файл с названием `<boot>/ssh` . При первой загрузке RPI включит SSH сервер, если обнаружит такой файл
    ```sh
    touch <boot>/ssh
    ```

1. Настройка сети
    1. Вариант A: Wi-Fi

        Cоздайте файл `<boot>/wpa_supplicant.conf`
        ```sh
        nano <boot>/wpa_supplicant.conf
        ```
        со следующим содерджимом:
        ```sh
        country=RU
        ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
        update_config=1

        network={
            scan_ssid=1
            ssid="your_wifi_ssid"
            psk="your_wifi_password"
        }
        ```
    1. Вариант B: настройка проводной сети

        **TODO**

4. Настройка хостнейма

    Для того, чтобы избежать конфликта, при нахождении в локальной сети нескольких устройств с одинаковым хостеймом, рекомендуется настроить каждой RPI уникальнное имя. Имя уточняйте у преподавателя.

    Отредактируйте хостнейм в файле `<rootfs>/etc/hostname`
    ```sh
    sudo nano <rootfs>/etc/hostname
    ```

## 3. Запуск

1. Вставьте MicroSD карту в RPI
2. Подключите адаптер питания
3. Подождите, чтобы RPI загрузился, обычно, хватает минуты, возможно, певрый запуск несколько дольше. RPI должна быть доступна по хостнейму, установленному неа предыдущем этапе. Хостнейм по-умолчанию: `raspberrypi`. Если она не доступна по хостнейму -  щито поделать. Попробуйте посмотреть в настройках роутера список клиентов WiFi. Попробуейте подключиться по проводной сети
4. Подключение к RPI
    ```sh
    ssh pi@raspberry
    ```
    Данные для входа
    ```
    hostname: raspberrypi
    username: pi
    password: raspberry
    ```
    Вы должны увидеть шелл (командную оболочку) RPI
    ```sh
    pi@raspberrypi: ~ $
    ```

Теперь вы можете подключаться к RPI по SSH, выполнять различные команды, а также передавать файлы в обе стороны по SCP.

## 4. Password-less connection
Чтобы не вводить пароль при каждом подключении и передаче файлов к RPI, необходимо настроить подключение по ключу.

1. Сгенерируйте ключ. На все вопросы утилиты можно нажимать Enter
    ```sh
    ssh-keygen
    ```
    В результате, будет сгенерирована пара приватного `~/.ssh/id_rsa` и публичного `~/.ssh/id_rsa.pub` ключей

2. Теперь необходимо установить публичный ключ на RPI. Проще всего это сделать командой
    ```sh
    ssh-copy-id pi@raspberrypi
    ```

## References

1. [Setting up a headless Raspberry Pi](https://jacobian.org/2021/jan/22/headless-rpi/)
2. [How to Set Up a Headless Raspberry Pi, Without Ever Attaching a Monitor](https://www.tomshardware.com/reviews/raspberry-pi-headless-setup-how-to,6028.html). Более детальная инструкция с картинками
3. [Rasberry Pi OS (официальная страница)](https://www.raspberrypi.org/software/)
