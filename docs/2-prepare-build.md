# Компиляция ядра Linux

Как было сказано ранее, мы будем кросс-компилировать модули ядра для RPI на хосте. Для компиляции модулей ядра требуется иметь собранное ядро той же версии, на которой планируются запускать модули. В противном случае, модули, собранные для другой версии ядра (или даже для версии ядра, собранной с другими параметрами) просто не запустятся!

> На этом шаге мы скачаем и установим все необходимые зависимости и сделаем все подготовительные шаги для выполнения лабораторной работы

## 1. Установка

Вначале необходимо установить все зависимости, необходимые для выполнения лабораторных работ (не надо скачивать их сейчас!):
 - Исходники ядра Linux для RPI: [https://github.com/raspberrypi/linux](https://github.com/raspberrypi/linux)
 - Тулчейн для сборки  [GNU Toolchain | ARM Developer](https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-a/downloads) (версия "x86_64 Linux hosted cross compilers - AArch32 target with hard float")
  
    **TODO**: с этим тулчейном не собирается, нужен тулчейн с сайта ARM

Этот репозиторий содержит скрипты, облегчающие установку ядра и тулчейна, сборку ядра, а также заготовки модулей ядра и всё прочее, что нужно для выполнения лабораторной работы.

1. Установите необходимые зависимости

    Ubuntu
    ```
    sudo apt install git bc bison flex libssl-dev make
    ```

    Arch Linux/Manjaro
    ```
    sudo pacman -S git bc bison flex openssl
    ```
1. Скачайте репозиторий в какую-то директорию. В дальнейшем, инструкция будет ссылаться на нее как на `<labs>`.
    ```
    git clone https://github.com/Garrus007/embedded-os-labs.git
    cd <repo>
    chmod +x scripts/*.sh
    ```
1. Установите Linux Kernel и тулчейн (ха-ха, небось уже скачал руками?)
    ```
    scripts/download_kernel.sh
    scripts/download_toolchain.sh
    ```
    Ядро и тулчейн скачются в директорию `<labs>/dist` и потом будут использоваться в ходе лабораторных работ

## 2. Сборка ядра
### **Лирическое отступление**
Linux работает на широком классе устройств - от встраиваемых устройств вроде RPI (и даже еще более маленьких) до огромных суперкомпьютеров. Потому что он очень гибко конфигурируемый и содержит в себе over9000 драйверов. Поэтому нельзя просто так взять и скачать "голое" ядро с официального сайта [kernel.org](https://www.kernel.org/), собрать, залить в RPI и думать, что всё будет работать.

Во-первых, мы уже скачали какое-то особое ядро с репозитопия Raspberry Pi Foundation, которое, видимо имеет какие-то отличия. Но этого недостаточно. Ядро необходимо правильно сконфигурировать!

Скачанные исходники ядра предоставляют какую-то конфигурацию по-умолчанию. Официальная инструкция по сборке ядра предлагает использовать именно ее. Эта конфигурация генерируется с помощью команды
```
make bcm2709_defconfig
```
Делать этого мы конечно же не будем. Я уже делал, и у меня не работал Wi-Fi. Видимо, его надо отдельно настроить в конфиге. Вместо этого мы возьмем готовый конфиг с работающей RPI.

Варианты:
 - [Вариант 1](#вариант-1): использовать конфиг текущего ядра и установить собранное ядро на RPI
 - [Вариант 2](#вариант-2): использовать конфиг от обновленного ядра и установить собранное ядро на RPI
 - [Вариант 3](#вариант-3): испоьзовать конфиг от обновленного ядра и НЕ устанавливать ядро на RPI

### **Вариант 1**
**Использовать конфиг текущего ядра и установить собранное ядро на RPI**

Наверное, самый идеаологически правильный с точки зрения работы со встраивемоей системой вариант. Мы получаем актуальное ядро и не выполняем какие-то действия на самом устройстве. Этот вариант проверен, все работает

#### **1. Подключить тулчейн**
Этот скрипт настроит все необходимые пути и переменные окружения
```
source scripts/env.sh
```
#### **2. Скачать конфиг с RPI**
1. Сначала необходимо включить возможность получить конфиг текущего запущенного ядра

    Подключитесь к RPI
    ```sh
    ssh pi@paspberrypi
    sudo modprobs config
    ```
1. Скачайте конфиг

    На хосте
    ```sh
    cd <labs>
    scp pi@raspberrypi:/proc/config.gz $DIST_DIR/.
    gunzip $DIST_DIR/config.gz
    ```
    Псссс! Ты же понимаешь, что если какие-то шаги придется повторить (напр. собрать ядро снова), скачивать конфиг заново не обязательно?

#### **3. Подготовка конфига**
1. Поместите конфиг в папку ядра
    ```sh
    cp $DIST_DIR/config $KERNEL_DIR/.config
    ```
2. Переименование ядра

    Чтобы отличать "стандартное" ядро RPI от собранного, его можно переименовать. Сделать это можно такой страшной командой либо в любом текстовом редакторе.
    ```sh
    cd $KERNEL_DIR
    sed -i -E 's/^CONFIG_LOCALVERSION="(.+)"/CONFIG_LOCALVERSION="\1-labs"/' .config
    ```
Если вы что-то сломаете в конфиге, вы сможете снова взять сохраненный конфиг с RPI

#### **4. Обновить конфиг**
У нас есть конфиг от рабочего ядра для RPI, но мы скачали исходники от более новой версии ядра. Чтобы собирать ядро более новой версии с конфигом от старой, нужно обновить конфиг. В новой версии появились новые опции конфигурации, которые нужно настроить. Скорее всего, это просто новые возможности, которые нам не нужны.

```sh
cd $KERNEL_DIR
make ARCH=arm CROSS_COMPILE=$CROSS_COMPILE oldconfig
```
На все вопросы отвечайте "No" (вводите `n` и нажимайте Enter)

#### **5. Сборка ядра**
Мы добрались до непосредственно сборки ядра. Не продолжайте сборку, если что-то упало! Сборка займет какое-то время.
```sh
cd $KERNEL_DIR
make ARCH=arm CROSS_COMPILE=$CROSS_COMPILE -j $(nproc)
make ARCH=arm CROSS_COMPILE="$CROSS_COMPILE" zImage modules dtbs -j $(nproc)
```

#### **6. Установка ядра на RPI**
Теперь надо установить собранное ядро, модули и Device Tree на RPI
1. Выключите RPI, извлеките MicroSD карту и вставьте в компьютер. Она должна отображаться в системе как два устройства под названиями `boot `и  `rootfs`.
1. Запустите скрипт для копирования файлов, указав путь до разделов
    ```
    scripts/install_kernel_rpi.sh <boot> <rootfs>
    ```
1. Извлеките MicroSD карту и вставьте ее обратно в RPI

#### **7. Проверка**
1. Подключите адаптер питания в RPI
1. Подождите, чтобы RPI загрузился
1. Подключитесь по SSH и проверьте версию ядра
    ```
    ssh pi@raspberry
    uname -a
    ```
    Пример вывода
    ```
    Linux raspberrypi 5.10.63-v7-labs+ #1 SMP Thu Sep 30 01:36:44 MSK 2021 armv7l GNU/Linux
    ```
    Если вы видите суффикс `-labs` в названии ядра, значит все получилось.

Мы собрали ядро и установили его на RPI.

#### **Очистка сборки**
Чтобу удалить всё, что было собрано, например, в случае ошибки (забыли укзаать ARCH или CROSS_COMPILE, забыли конфиг итп), выполните
```sh
cd $KERNEL_BUILD
make ARCH=arm CROSS_COMPILE=$CROSS_COMPILE distclean
make distclean # не знаю, нужно или нет, но пусть будет
```

### **Вариант 2**
**Использовать конфиг от обновленного ядра и установить собранное ядро на RPI**


### **Вариант 3**
**Использовать конфиг от обновленного ядра и установить собранное ядро на RPI**


## Заметки о версии ядер
После установки свежей Raspberry Pi OS (2021-09-29)
```
$ uname -a
Linux raspberrypi-1 5.10.17-v7+ #1414 SMP Fri Apr 30 13:18:35 BST 2021 armv7l GNU/Linux
$ ls /lib/modules
5.10.17+  5.10.17-v7+  5.10.17-v7l+  5.10.17-v8+
```

Ядро из исходников: 5.10.63

## References
1. [The Linux Kernel - Raspberry Pi Documentation](https://www.raspberrypi.org/documentation/computers/linux_kernel.html) - официальная инструкция по сборке и установке ядра Linux для RPI
1. [Сборка ядра Linux](https://losst.ru/sobiraem-yadro-linux)

## Примечания
 - Тулчейн [RPI/tools](https://github.com/raspberrypi/tools) не подходит. Что-то ругается на флаг -Wdate-time. Видимо, слишком новый флаг.

